import type { AxiosAdapter, AxiosRequestConfig } from 'axios'
import { nanoid } from 'nanoid'

/**
 * @description First version use cancel token
 * then transform to AbortController by doubao
 */

interface IAxiosCancelPoolItem {
  // key, generated by buildSortedURL
  k: string
  // path, location.pathname
  p: string
  // AbortController instance
  ac: AbortController
}

const AxiosCancelPoolRef = shallowRef(new Map<string, IAxiosCancelPoolItem>())

function addToCancelPool(config: AxiosRequestConfig, id: string, pathname: string, controller: AbortController) {
  const key = buildSortedURL(config.url, config.params, config.paramsSerializer)

  AxiosCancelPoolRef.value.set(id, {
    k: key,
    p: pathname,
    ac: controller,
  })
}

function removeFromCancelPool(id: string, excuteCancel = false) {
  const target = AxiosCancelPoolRef.value.get(id)

  if (target) {
    excuteCancel && target.ac.abort()
    AxiosCancelPoolRef.value.delete(id)
  }
}

// cancel the latest request that do not receive a response
export function removeLatestRequest() {
  const lastestItem = Array.from(AxiosCancelPoolRef.value).pop()

  if (lastestItem) {
    lastestItem[1].ac.abort()
    AxiosCancelPoolRef.value.delete(lastestItem[0])
  }
}

// cancel all the request that currently do not have a response
export function removeAllCancel() {
  const arr = Array.from(AxiosCancelPoolRef.value)

  for (let i = 0; i < arr.length; i++) {
    const id = arr[i][0]
    const element = arr[i][1]
    element.ac.abort()
    AxiosCancelPoolRef.value.delete(id)
  }
}

// remove all requests in current page from cancel pool
export function removeCurrentPageRequests(path: string) {
  const arr = Array.from(AxiosCancelPoolRef.value).filter(i => i[1].p === path)

  for (let i = 0; i < arr.length; i++) {
    const id = arr[i][0]
    const element = arr[i][1]
    element.ac.abort()
    AxiosCancelPoolRef.value.delete(id)
  }
}

export function cancelAdapterEnhancer(adapter: AxiosAdapter): AxiosAdapter {
  return async (config) => {
    const requestId = nanoid(16)

    // generate request id
    config._request_id = requestId

    // create AbortController and add to cancel pool
    const controller = new AbortController()
    config.signal = controller.signal // 设置 AbortSignal
    addToCancelPool(config, requestId, location.pathname, controller)

    // set pathname to current request to identify which page is current request sent
    config._request_from_route_path = location.pathname

    try {
      const res = await adapter(config)
      // request finished successfully, remove from the cancel pool
      removeFromCancelPool(requestId)
      return res
    }
    catch (error) {
      // request failed, remove from the cancel pool
      removeFromCancelPool(requestId)
      throw error
    }
  }
}
